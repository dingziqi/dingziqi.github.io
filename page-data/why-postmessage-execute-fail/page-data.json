{"componentChunkName":"component---src-templates-blog-post-js","path":"/why-postmessage-execute-fail/","result":{"data":{"site":{"siteMetadata":{"title":"D.Z"}},"markdownRemark":{"id":"301309ee-eb7e-5ae2-8402-702bbd6c220c","excerpt":"最近在使用了的项目中遇到了一个报错，报错的大致内容如下： 当时的html页面结构大致是这样： 从报错信息来看似乎是因为调用 postMessage 传入的 targetOrigin 和对应 iframe 实际的 url 不一致导致的，那这可能是 postMessage 对 targetOrigin…","html":"<p>最近在使用了<code class=\"language-text\">postMessage</code>的项目中遇到了一个报错，报错的大致内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(index):20 Failed to execute 'postMessage' on 'DOMWindow':\nThe target origin provided ('http://www.a.com') does not match the recipient\nwindow's origin ('http://www.b.com').</code></pre></div>\n<p>当时的html页面结构大致是这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  ...\n  <span class=\"token comment\">&lt;!-- www.b.com --></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n      <span class=\"token operator\">...</span>\n      <span class=\"token comment\">// 这里是在一个异步操作中</span>\n      iframe<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">'http://www.a.com'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token operator\">...</span>\n      <span class=\"token comment\">// 有多次 postMessage 操作</span>\n      iframe<span class=\"token punctuation\">.</span>contentWindow<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://www.a.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>从报错信息来看似乎是因为调用 postMessage 传入的 targetOrigin 和对应 iframe 实际的 url 不一致导致的，那这可能是 postMessage 对 targetOrigin 校验错误信息。但是我 postMessage 中设置的 targetOrigin 是和 iframe 的 url 是一模一样的。而且错误信息中提示我 recipient window 的origin 是 <a href=\"http://www.b.com%EF%BC%8C%E6%88%91%E5%B9%B6%E6%B2%A1%E6%9C%89%E7%BB%99\">http://www.b.com，我并没有给</a> iframe 设置过类似的 url。并且后续的 postMessage 操作又没有报这个错误了。</p>\n<p>经过我一番 debug 之后才发现，报错是发生在异步设置 iframe 的 src 之前，也就是说是当时的 iframe 的 src 并没有值。但是抛出的异常信息又说 recipient window 的 origin 的值是 b.com，简直是在误导我…</p>\n<p>并且，我 debug 的过程中我还发现了一个更毁三观的问题。当我试着把 iframe 的 src 改成 <a href=\"http://www.baidu.com\">http://www.baidu.com</a> （与 targetOrigin 不同时），竟然不会报上面那个错。WTF！那我前面的猜想<code class=\"language-text\">那这可能是 postMessage 对 targetOrigin 校验错误信息</code> 不就是错的了。</p>\n<p>我只好又写了几个 demo 来测试，最后发现只有在 iframe 的 src 没有值，或者它的值中的主机名与 targetOrigin 中的主机名一致，但是 origin 又不一致（即端口或者协议不同）的情况下才会抛出是上面那个错误。如： <code class=\"language-text\">http://www.a.com</code> 与 <code class=\"language-text\">http://www.a.com:8080</code> 才会报错。<code class=\"language-text\">http://www.a.com</code> 与 <code class=\"language-text\">http://www.b.com</code> 这样并不会报错，只是 message 不会被传递而已。</p>\n<p><strong>另外讲一个写 demo 过程中发现的问题。</strong> <a href=\"https://codepen.io/\">https://codepen.io/</a> 和 <a href=\"https://jsbin.com/\">https://jsbin.com/</a> 这两个在线编辑器中，如果我在 <code class=\"language-text\">HTML</code> tab 中有 iframe 标签的话，那我在 <code class=\"language-text\">JavaScript</code> tab 编写的内容会被添加我自己编写的 iframe 中…。这个 bug 也是醉人呐~</p>","frontmatter":{"title":"postMessage execute fail 之谜","date":"11-21, 2019","description":null,"tags":"bug"}},"previous":{"fields":{"slug":"/webpack-devtool-config/"},"frontmatter":{"title":"详解 webpack devtool 配置"}},"next":{"fields":{"slug":"/error-collection-in-javascript/"},"frontmatter":{"title":"JavaScript中的错误收集"}}},"pageContext":{"id":"301309ee-eb7e-5ae2-8402-702bbd6c220c","previousPostId":"8879d3b6-43d3-5bae-8fb8-d96c26110377","nextPostId":"f055dbb9-11eb-51f7-8a41-8aa9ecd9c723"}},"staticQueryHashes":["2841359383"]}